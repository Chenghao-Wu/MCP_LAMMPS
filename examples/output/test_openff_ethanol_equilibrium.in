# LAMMPS Equilibrium MD Script
# Generated by MCP LAMMPS - Best Practice Protocol
#
# Simulation Configuration:
#   Temperature: 300.0 K
#   Pressure: 1.0 atm
#   Timestep: 1.0 fs
#   System Type: generic
#
# Protocol Stages:
#   1. Energy Minimization: 10000 steps
#   2. NVT Heating: 10000 steps
#   3. NPT Density Equilibration: 100000 steps
#   4. NPT Production: 1000000 steps
#
# Total simulation time: 1000.0 ps


# ============================================================================
# INITIALIZATION
# ============================================================================

units           real
atom_style      full
boundary        p p p

# Read structure
read_data       /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol.lmp


# ============================================================================
# FORCE FIELD
# ============================================================================
# Note: Force field parameters are read from the data file
# The data file should contain all pair_coeff, bond_coeff, angle_coeff, etc.


# ============================================================================
# SIMULATION SETTINGS
# ============================================================================

# Neighbor list settings
neighbor        2.0 bin
neigh_modify    every 1 delay 0 check yes

# Thermodynamic output
thermo          1000
thermo_style    custom step temp press pe ke etotal vol density
thermo_modify   flush yes


# ============================================================================
# STAGE 1: ENERGY MINIMIZATION
# ============================================================================
# Purpose: Remove bad contacts and overlaps from initial structure
# Method: CG minimization
# Convergence: Energy < 0.0001, Force < 1e-06

print "=========================================="
print "Starting Stage 1: Energy Minimization"
print "=========================================="

minimize        0.0001 1e-06 10000 10000

# Save minimized structure
write_data      /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_minimized.data
write_restart   /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_minimized.restart

print "Minimization complete"
print ""

# Reset timestep counter
reset_timestep  0


# ============================================================================
# STAGE 2: NVT HEATING
# ============================================================================
# Purpose: Gradually heat system from 150.0 K to 300.0 K
# Ensemble: NVT (constant volume)
# Timestep: 0.5 fs (shorter for stability)
# Duration: 10000 steps (5.0 ps)

print "=========================================="
print "Starting Stage 2: NVT Heating"
print "=========================================="

# Set shorter timestep for heating
timestep        0.5

# Initialize velocities at starting temperature
velocity        all create 150.0 12345 dist gaussian

# NVT ensemble with gradual heating
fix             nvt_heat all nvt temp 150.0 300.0 100.0

# Velocity rescaling for stability
fix             vrescale all temp/rescale 100 150.0 300.0 0.02 1.0

# Run heating phase
run             10000

# Remove fixes
unfix           nvt_heat
unfix           vrescale

# Save heated structure
write_data      /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_heated.data
write_restart   /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_heated.restart

print "NVT heating complete"
print ""

# Reset timestep counter
reset_timestep  0


# ============================================================================
# STAGE 3: NPT DENSITY EQUILIBRATION
# ============================================================================
# Purpose: Equilibrate density at target pressure
# Ensemble: NPT (constant pressure)
# Timestep: 1.0 fs
# Duration: 100000 steps (100.0 ps)
# Pressure: 1.0 atm (iso)

print "=========================================="
print "Starting Stage 3: NPT Density Equilibration"
print "=========================================="

# Set production timestep
timestep        1.0

# NPT ensemble for density equilibration
fix             npt_density all npt temp 300.0 300.0 100.0 iso 1.0 1.0 1000.0

# Monitor density convergence
variable        current_density equal density
fix             density_avg all ave/time 100 10 1000 v_current_density file /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_density_equilibration.dat

# Run density equilibration
run             100000

# Remove fixes
unfix           npt_density
unfix           density_avg

# Save equilibrated structure
write_data      /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_equilibrated.data
write_restart   /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_equilibrated.restart

print "Density equilibration complete"
print "Final density: ${current_density} g/cm^3"
print ""

# Reset timestep counter
reset_timestep  0


# ============================================================================
# STAGE 4: NPT PRODUCTION
# ============================================================================
# Purpose: Production run for data collection
# Ensemble: NPT (constant pressure)
# Timestep: 1.0 fs
# Duration: 1000000 steps (1000.0 ps)

print "=========================================="
print "Starting Stage 4: NPT Production"
print "=========================================="

# NPT ensemble for production
fix             npt_prod all npt temp 300.0 300.0 100.0 iso 1.0 1.0 1000.0

# Trajectory output
dump            traj all custom 10000 /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_trajectory.lammpstrj id type x y z
dump_modify     traj sort id

# Restart files for continuation
restart         100000 /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_restart.*.restart

# Enhanced thermodynamic output
thermo          1000
thermo_style    custom step temp press pe ke etotal vol density cpu

# Run production
run             1000000

# Clean up
unfix           npt_prod
undump          traj

# Save final structure
write_data      /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_final.data
write_restart   /home/zhenghaowu/mcp_lammps/examples/output/test_openff_ethanol_final.restart

print "Production run complete"
print ""


# ============================================================================
# SIMULATION COMPLETE
# ============================================================================

print "=========================================="
print "All stages completed successfully"
print "=========================================="
